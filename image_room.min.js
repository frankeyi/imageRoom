(function(g){var i=g('<div style="position:fixed;z-index:102;left:0;top:0;right:0;bottom:0;background:#1a1a1a;overflow:hidden;"></div>');var a=g('<ul style="position:absolute;height:100%;"></ul>');var f=g('<div style="position:absolute; bottom:10px; width:100%; height:20px; text-align:center;"></div>');var d='<li style="float:left;height:100%;position:relative; overflow:hidden;"></li>';var e='<div class="room_img_loading" style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:url(http://s-static.oss-cn-qingdao.aliyuncs.com/loading.gif);background-repeat:no-repeat;background-position:center;">';var b='<div style="width:10px;height:10px;background:#ccc;display:inline-block; margin:0 2px;"></div>';var c=false;var j=function(l,n,k,m){return Math.sqrt((k-l)*(k-l)+(m-n)*(m-n))};var h=function(r,q,p,n,o,k){var t=o/p;var m=r*t;var s=k/n;var l=q*s;return{x:m,y:l}};g.fn.extend({room:function(){if(!c){c=true;i.append(a);i.append(f)}var u=g(this);var R=u.size();var I=false;var p,N;var F=0;var D;var M=0,r,Q,o=0,n=0;var H,t,G,s,l,k,L=false;var x,C;var O="";var J;var B,X,z,W,w,m,y,E;var v=function(Y,ab){var aa=Y-parseInt(r.css("left"));var Z=ab-parseInt(r.css("top"));return{x:aa,y:Z}};var T=function(Y,ab){var aa=Y+parseInt(r.css("left"));var Z=ab+parseInt(r.css("top"));return{x:aa,y:Z}};var U=function(aa){var Y=0;var Z="";D=new Array;F=aa;p=g(window).width();N=g(window).height();a.find("li").remove();a.css({left:0,width:p*R});f.html("");u.each(function(ab){var ac=g(d);var ad=g(e);ac.width(p);ac.append(ad);a.append(ac);D.push(ac);f.append(b)});g(document.body).append(i);V(true);a.bind({dragstart:function(){return false},mousewheel:function(ab){if(ab.deltaY>0){q()}else{S()}ab.preventDefault()},touchstart:function(ab){r=D[F].find("img");J=new Date().getTime();Y=0;O="";Z="";Q=null;if(event.touches.length==1){l=H=event.touches[0].pageX;k=G=event.touches[0].pageY;t=0;o=parseInt(r.css("left"));n=parseInt(r.css("top"))}if(event.touches.length==2){m=true;w=j(event.touches[0].pageX,event.touches[0].pageY,event.touches[1].pageX,event.touches[1].pageY);y=D[F].width();E=D[F].height()}ab.preventDefault()},touchmove:function(av){if(O==""){if(event.touches.length==1){t=event.touches[0].pageX-H;if((t<-5||event.touches[0].pageY-G<-5)||(t>5||event.touches[0].pageY-G>5)){O="move"}}if(event.touches.length==2){O="scale"}}if(O=="move"){var ai=parseInt(r.css("left")),af=parseInt(r.css("top"));var ak=event.touches[0].pageX,aj=event.touches[0].pageY;var ad;var au=Math.atan2(Math.abs(aj-k),Math.abs(ak-l))/Math.PI*180;if(k!=aj&&au>30){ad="updown"}else{if(l>ak){ad="left"}if(l<ak){ad="right"}}if(Z==""||Z=="scale"){if(ad=="updown"&&r.height()>r.attr("init-height")){Z="scale"}else{if((ad=="right"&&ai<0)||(ad=="left"&&ai+r.width()>p)){Z="scale"}else{Z="switch"}}}if(Z=="scale"){var ar,al;if(ad=="right"){ar=o+(ak-H)>0?0:o+(ak-H)}if(ad=="left"){ar=o+(ak-H)<-(r.width()-p)?-(r.width()-p):o+(ak-H)}if(ad=="updown"){ar=o+(ak-H);if(ar>0){ar=0}if(ar<-(r.width()-p)){ar=-(r.width()-p)}}al=n+(aj-G);r.css({left:ar,top:al});Y=ak-H}if(Z=="switch"){t=ak-H-Y;a.css({"left":M+t})}l=ak;k=aj}if(O=="scale"&&m){var ah=r.attr("src-width"),aq=r.attr("src-height");var aw=j(event.touches[0].pageX,event.touches[0].pageY,event.touches[1].pageX,event.touches[1].pageY);var ax=Math.ceil(aw-w)/100;var ae=r.width(),an=r.height(),ai=parseInt(r.css("left")),af=parseInt(r.css("top"));var am=ae+ae*ax>=ah?ah:ae+ae*ax,at=an+an*ax>=aq?aq:an+an*ax;var ac=(event.touches[1].pageX-event.touches[0].pageX)/2+event.touches[0].pageX,ab=(event.touches[1].pageY-event.touches[0].pageY)/2+event.touches[0].pageY-g(window).scrollTop();var ag=v(ac,ab);ag.x=ag.x>0?ag.x:0;ag.x=ag.x>ae?ae:ag.x;ag.y=ag.y>0?ag.y:0;ag.y=ag.y>an?an:ag.y;var ao=T(ag.x,ag.y);var ap=h(ag.x,ag.y,ae,an,am,at);r.css({width:am,height:at,maxWidth:am,maxHeight:at,minWidth:am,minHeight:at});if(ah!=am){r.css({left:ai+(ao.x-(ap.x+ai)),top:af+(ao.y-(ap.y+af))})}w=aw;y=D[F].width();E=D[F].height()}av.preventDefault()},touchend:function(ad){if(O==""){if(new Date().getTime()-J<250){a.trigger("click");return}}if(O=="scale"){m=false;if(r.width()<r.attr("init-width")||r.height()<r.attr("init-height")){var ac=r.attr("init-width");var ae=r.attr("init-height");r.animate({width:ac,height:ae,maxWidth:ac,maxHeight:ae,minWidth:ac,minHeight:ae,left:(p-ac)/2,top:(N-ae)/2},"fast")}}if(O=="move"){var ab=p*0.15;if(t>-ab&&t<ab){V()}else{if(t>0){Q=r;q()}else{if(t<0){Q=r;S()}}}}},click:function(){P()}})};var A=function(Z){var Y,aa;x=Z.attr("src-width");C=Z.attr("src-height");if(x>p||C>N){if(p/x<N/C){Y=p;aa=p/x*C}else{Y=N/C*x;aa=N}}else{Y=x;aa=C}Z.attr("init-width",Y);Z.attr("init-height",aa);Z.css({width:Y,height:aa,maxWidth:Y,maxHeight:aa,minWidth:Y,minHeight:aa,left:(p-Y)/2,top:(N-aa)/2})};var K=function(){var Z=u.eq(F);var Y=D[F];if(Y.find(".room_img_loading").size()==0){return}var ab=Z.attr("data-room-src");var aa=new Image;aa.onload=function(){var ac=g('<img src="'+ab+'" style="position:absolute;" />');ac.attr("src-width",this.width);ac.attr("src-height",this.height);
Y.find("*").remove();A(ac);Y.append(ac)};aa.src=ab};var V=function(Y){M=-F*p;if(Y){a.css({left:M})}else{a.stop().animate({left:M},"fast")}K();f.find("div").css("background","#ccc").eq(F).css("background","#666")};var q=function(){F--;if(F<0){F=0}else{if(Q){A(Q)}}V()};var S=function(){F++;if(F==R){F=R-1}else{if(Q){A(Q)}}V()};var P=function(){i.remove()};u.each(function(Y){g(this).click(function(){U(Y)})})}})})(jQuery);
